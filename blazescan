#!/bin/bash

#making log location
if [[ -e /home/scan ]];then #then pwd exists
	echo -e 
else
mkdir -p /home/scan
fi

#set sigdir
sigdir=/home/scan/lw-yara

if [[ -e /home/scan/lw-yara/lw.hdb ]]; then #rules installed, run update
	cd $sigdir
	git pull
else git clone https://github.com/Hestat/lw-yara.git $sigdir
fi

#create formatting
div(){
  for ((i=0;i<$1;i++)); do printf '='; done;
}

header(){
	echo -e "\n$(div 40)\n"
}

header2=$(echo -e "$(div 3)")

title=$(
echo    "                      __________________"
echo    "                      \                 \ "
echo    "                       \                 \ "
echo    "                        \            )    \ "
echo    "                         \          ).(    \ "
echo    "       /-------------------------).(.(------"
echo    "     //---------------//   (     ).(.   //  |"
echo    "    //                //    (.)   ).(. // __|"
echo    "   //               //   ) .( .( ).)) //    ||"
echo    "  //               // ).( .( .) .(.).//     ||"
echo    " //_______________//  ^^^^^^^^^^^^^^//      ||"
echo    "------------------------------------/ ------ |"
echo    "| Blazescan   |         |  Another  |        |"    
echo    "| AMS Software|         |  Malware  |        |"   
echo    "|--------------         |  Scanner  |        |"   
echo    "|                       ------------|        |"
echo    "----------------------------------------------" 
echo    "Sometimes you need to burn it down and start fresh"

)

#creating log file
OP1=/home/scan/scan-$(date +%F-%H%M.txt)

echo -e "\n"|tee -a $OP1 

if [[ -x $(which whmapi1) ]]; then #cpanel

	#begin menu for cpanel options
	while true
	do
		clear
		header
		echo  $title
		echo -e
		echo -e "Please select scan you would like to run\n"
		echo -e "Select 1 to scan all Cpanel accounts and Docroots\n"
		echo -e "Select 2 to scan individual account\n"
		echo -e "Select 3 to exit\n"
		header
read answer
case "$answer" in

	
	1) if [[ -x $(which clamscan) ]]; then #clamav installed
		for FILE in $(find /var/cpanel/userdata/ -type f | xargs grep documentroot | awk -F":" '{print$1}' | egrep -v "(cache|SSL|nobody)" | xargs grep documentroot | awk -F":" '{print $3}'); do echo -e "Scan location:\t$FILE\n" | tee -a $OP1 
		clamscan -ir --no-summary -d /root/lw-yara/lw.hdb -d /root/lw-yara/lw-rules_index.yar $FILE | tee -a $OP1; echo -e "\n" | tee -a $OP1 ; done; echo -e "Scan output file can be found here: $OP1"
	else echo -e "trying to link to existing clamscan binary"
		ln -s /usr/local/cpanel/3rdparty/bin/clamscan /usr/bin/clamscan 
		ln -s /usr/local/cpanel/3rdparty/bin/freshclam /usr/bin/freshclam
		if [[ -x $(which clamscan) ]]; then 
			echo -e "success, please restart to scan"
			else echo -e "clamav not installed please install"
		fi
	fi;;

	2) #creating log file
		OP2=/home/scan/scan-$(date +%F-%H%M.txt)
		echo -e "\n"|tee -a $OP2
		echo "What is the cpanel user?"
		read user
		clamscan -ir --no-summary -d /root/lw-yara/lw.hdb -d /root/lw-yara/lw-rules_index.yar /home/$user/public_html/ | tee -a $OP2
	       	echo -e "\nScan output file can be found here: $OP2";;

	3) exit;;
	esac
	echo -e "Press Enter to return to menu"
	read input
done
else
	echo -e "not cpanel, exiting"
fi
